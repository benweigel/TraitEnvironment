---
title: "Estimating CWM traits and diversity indices"
author: "Martin Lindegren, DTU Aqua (and modifed code from Esther Beukhof)"
date: "12 May 2021"
output:
  html_document: 
    keep_md: yes
  word_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This document provides an example data and R code for estimating Community Weighted Mean (CWM) traits and diversity indices, as well as plotting patterns and identifying key drivers and state-pressure relationships (using GAMs and random forest). 

# 1. Preliminaries

## 1.1. Load packages

The analyses require the R packages `FD`, `mgcv`, `ggplot2`, `RcolorBrewer`, `randomForest` and `MuMIn`.

```{r, message=FALSE}
# Clear memory
rm(list=ls())
# Load packages
library(FD) ## Calculate functional diversity indices
library(mgcv)
library(ggplot2)
library(RColorBrewer)
library(randomForest)
library(MuMIn)
```

If you get an error message, check that the R packages are installed correctly. If not, use the command: `install.packages(c("FD", "mgcv", "ggplot2", "RColorBrewer", "randomForest", "MuMIn"))`.

The example dataset is available as the Rdata file `NorthSea_FishTraitEnv.Rdata`, available for download [here](https://github.com/rfrelat/TraitEnvironment/raw/main/NorthSea_FishTraitEnv.Rdata).  

## 1.2 Load and inspect data

Make sure the file `NorthSea_FishTraitEnv.Rdata` is in your working directory, then load it in R.

```{r}
load("NorthSea_FishTraitEnv.Rdata")
```

The Rdata file contains four objects: 
- `abu` Species abundance by grid cell (the community matrix)
- `env` Environmental conditions by grid cell
- `trait` Traits by species
- `coo` The spatial coordinates (lat/lon) for each grid cell

```{r}
# Inspect data tables 
head(abu) 
head(env) 
dim(env)
names(env)

head(trait)
dim(trait)
names(trait)

head(coo)
```

Importantly, the rows in `abu` correspond to the same grid cell than the rows in `env`, and the column in `abu` correspond to the same taxa than the rows in `trait`.  
If you want to learn more about this dataset and how to create it, see the short tutorial on setting trait-environement dataset in XXX.

```{r}
all(row.names(abu)==row.names(env))
all(colnames(abu)==row.names(trait))
```

Using this fish community of the North Sea as an example, you will learn how to estimate CWM traits and diversity indices, 
as well as plotting patterns and identifying key drivers and state-pressure relationships (using GAMs and random forest)


# 2. Calculate Community-weighted mean (CWM) traits and various diversity indices 

## 2.1 Calculate diversity indices

We use the function `FD()` from the `FD package`. Please see the help `?dbFD` to inspect the function and all its options. 

Be aware, the computation of `FD` can take several minutes.
```{r}
FD<-dbFD(trait, abu, stand.FRic=T)  
#stand.FRic=T, means FRic will range between 0 and 1
```

## 2.2 Inspect results

```{r}
FD$nbsp  ### Species Richness              
FD$FRic  ### Functional Richness           
FD$FEve  ### Functional Eveness            
FD$FDiv  ### Functional Divergence         
FD$RaoQ  ### Functional Entropy            
FD$CWM   ### Community weighted mean traits 
```

## 2.3 Reformat the output

```{r}
# Reformat into an output data frame
FD<-do.call(cbind, FD)

## Add lon, lat to output data frame
FD[,c("lon","lat")]<-coo
```


# 3. Plot biodiversity indices by lat,long

We will define a function to plot a map with the diversity indices (no need to fully understand the R-code of the function here).

```{r}
colpal<-rev(brewer.pal(11,"RdYlBu")) # Color palette for the map
# Plotting function 
funPlot<-function(Var){
  colnames(FD)[which(colnames(FD)==Var)]<-"Var"
  ggplot() +
    geom_tile(data=FD,aes(x=lon,y=lat,fill=Var)) + # 
    scale_fill_gradientn(name = Var, colours=colpal, na.value = 'white')+#,limits=c(0,25100)) +
    borders(fill="gray44",colour="black") +
    coord_quickmap(xlim=c(range(FD$lon)),ylim=c(range(FD$lat)))+
    labs(x = "Lon",y="Lat")+
    theme(legend.position = c(0.93,0.8))+
    theme(legend.title = element_text(size = 8),legend.text = element_text(size = 7))+
    guides(shape = guide_legend(override.aes = list(size = 0.2)))+
    theme(panel.background = element_rect(fill=alpha('light blue', 0.4), colour = 'black'))
}


```

```{r}
# list all output of FD calculation
Metrics<-colnames(FD)
Metrics

#We plot the CWM of Trophic level, which is the 9th variable
funPlot(Var=Metrics[9])# Plot CWM traits and diversity metrics
```

# 4. Statistically investigate trait-environment relationships

Here, we model with GAMS and random forest the trait responses at the community level (using CWM).


## 4.1 Preparation of the dataset

We want to model CWM from environmental data, so we need to merge these information in one data frame.

```{r}
# Merge FD with env data frame
# Because the rows of FD match the rows of env, we can combine them
FDenv<-cbind(FD,env)
head(FDenv)
```
## 4.2 Simple exploratory GAMs

We use the function `gam()` from the `mgcv package`. Please see the documentation `?gam` to inspect the function and all its options. 


We define a function to quickly plot GAM partial smooth plots and return summary statistics for the fitted model


```{r}
funGam<-function(Var){
  colnames(FDenv)[which(colnames(FDenv)==Var)]<-"Var"
  fit<-gam(Var~s(Depth, k=3)+s(SBT,k=3)+s(SBS,k=3)+s(Chl,k=3)+s(SBT_sea,k=3)+ s(Chl_sea, k=3)+s(Fishing, k=3), na.action=na.exclude, data=FDenv)
  par(mfrow=c(4,2),mar=c(4,4,0.2,0.2))
  plot(fit,shade=T,shade.col="grey",res=T,rug=F,pch=20,ylab="")
  par(mfrow=c(1,1),mar=c(5,4,2,2))
  return(summary(fit))
}
```

Now, let's try to model trophic level from environmental data 

```{r}
#Plot GAM partial smooth plots and return summary statistics for the fitted model
funGam(Metrics[9])
```

## 4.3 Detailed and thorough model selection

## 4.3.1 Considering potential spatial autocorrelation

Here we use a mixed GAM approach taking into account potential spatial autocorrelation (by allowing for correlated error structures)
We use the function `uGamm()` from the `MuMIn package` which is a wrapper function for gamm. Please see the documentation `?uGamm` to inspect the function and all its options. 


```{r}
# Create dummy variable to include as random factor
dummy <- rep(1, dim(FDenv)[1]) ### Dummy variables to be add as random factor (mandatory, but won't 'change' anything)

# Trophic level as an example
# Check distribution of response
hist(FDenv$CWM.Trophic.level) 
# Consider log transforming or change family statement in gam in case of strong deviations from normal distribution 

```


```{r}
fitTL <- uGamm(CWM.Trophic.level ~ s(Depth, k=3)
                   +s(SBT,k=3)
                   +s(SBS,k=3)
                   +s(Chl,k=3)
                   +s(SBT_sea,k=3)
                   +s(Chl_sea, k=3)
                   +s(Fishing, k=3),
                   gaussian(link = "identity"),random = list(dummy=~1), correlation = corGaus(form = ~ lon+lat), # Can try other error structures
                   data = FDenv, control=lmeControl(opt="optim"))
# Inspect summary statistics
summary(fitTL$lme)
summary(fitTL$gam)

```


```{r}
# Check diagnostics
par(mfrow=c(2,2))
gam.check(fitTL$gam)
```



```{r}
par(mfrow=c(4,2),mar=c(4,4,0.2,0.2))
plot(fitTL$gam,shade=T,shade.col="grey",res=T,rug=F,pch=20)
par(mfrow=c(1,1),mar=c(5,4,2,2))
```

## 4.3.2 Automated model selection

Here, we perform automated model selection testing all combinations of predictors using the `dredge()` function (and rank according to AICc)
Please see the documentation `?dredge` from the `MuMIn package` to inspect the function and all its options.

**Be aware, the computation of `FD` can take several minutes.**
```{r}
results <- dredge(fitTL, m.lim=c(1,4), rank="AICc") # Here test max 4 variables per model to reduce run time
subset(results, delta <5)  # Depth, SBT and fishing are key variables
# Calculate and view relative variable importance (RVI) scores
importance(results) 
```

```{r}
# Fit and inspect the "best" model
fitTLb <- uGamm(CWM.Trophic.level ~ s(Depth, k=3)
               +s(SBT,k=3),
               #+s(Fishing, k=3),
               gaussian(link = "identity"),random = list(dummy=~1), correlation = corGaus(form = ~ lon+lat), # Can try other error structures
               data = FDenv, control=lmeControl(opt="optim"))
```

```{r}
# Inspect summary statistics
summary(fitTLb$lme)
summary(fitTLb$gam)
```

```{r}
# Check diagnostics
par(mfrow=c(2,2))
gam.check(fitTLb$gam)
```

```{r}
# Plot model smooth terms
par(mfrow=c(2,1),mar=c(4,4,0.2,0.2))
plot(fitTLb$gam,shade=T,shade.col="grey",res=T,rug=F,pch=20)
```


#5. Random forest

Instead of GAM, we can try to model the CWM trait with random forest. 
We use the function `randomForest()` from the `randomForest package`. Please see the documentation `?randomForest` to inspect the function and all its options. 

Again we create a function to simply compute random forests
```{r}
# Wrapper function to explore RF for a given trait
funRf<-function(Var){
  colnames(FDenv)[which(colnames(FDenv)==Var)]<-"Var"
  fit<-randomForest(Var~Depth+SBT+SBS+Chl+SBT_sea+Chl_sea+Fishing, data=FDenv,ntree=1000,importance=T, mtry=2)
  par(mfrow=c(4,2),mar=c(4,4,0.2,0.2))
  partialPlot(fit, x.var=Depth,FDenv,main="")
  partialPlot(fit, x.var=SBT,FDenv,main="")
  partialPlot(fit, x.var=SBS,FDenv,main="")
  partialPlot(fit, x.var=Chl,FDenv,main="")
  partialPlot(fit, x.var=SBT_sea,FDenv,main="")
  partialPlot(fit, x.var=Chl_sea,FDenv,main="")
  partialPlot(fit, x.var=Fishing,FDenv,main="")
  par(mfrow=c(1,1),mar=c(5,4,2,2))
  return(fit)
}
```

Now, we compute the randomForest for CWM trophic level.
```{r}
fitTLrf <- funRf(Metrics[9])# Plot random forest response plots and summary stats
```

### Check error against number of trees used for training
```{r}
plot(fitTLrf) 
```
It is stable after 200 (hence 100 trees is more than enough).

### Inspect summary stats
```{r}
print(fitTLrf) # Inspect summary stats
```

### Check variable importance plots

```{r}
varImpPlot(fitTLrf)
```



# Conclusion 

# References

# Optional - GLMM

We test GLMM and extract parameters to facilitate comparisons across organism groups and areas. 

Please note that you may need to introduce square terms to account for non-linearities.

Additionnally, you need to load the package `nlme`.

```{r}
library(nlme)
fitTLglm <- lme(CWM.Trophic.level~Depth+SBT+SBS+Chl+SBT_sea+Chl_sea+Fishing,
                random = list(dummy=~1), correlation = corGaus(form = ~ lon+lat), # Can try other error structures
                data = FDenv, control=lmeControl(opt="optim"))
summary(fitTLglm)
anova(fitTLglm)

# Extract parameters
str(summary(fitTLglm))
summary(fitTLglm)$coefficients


##Plot some diagnostics
plot(fitTLglm)
qqnorm(residuals(fitTLglm))

#observed versus fitted values
plot(fitTLglm, CWM.Trophic.level~ fitted(.), abline = c(0,1))
```

